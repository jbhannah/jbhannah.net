---
resources:
  - name: git
    type: git
    icon: github-circle
    source:
      uri: https://github.com/jbhannah/jbhannah.net.git
      branch: master
  - name: base-spec
    type: git
    source:
      uri: https://github.com/jbhannah/jbhannah.net.git
      paths:
        - Dockerfile.base
  - name: base
    type: registry-image
    source:
      repository: jbhannah/jbhannah.net
      tag: base
      username: ((docker.username))
      password: ((docker.password))
  - name: deps
    type: git
    source:
      uri: https://github.com/jbhannah/jbhannah.net.git
      paths:
        - Dockerfile.builder
        - package.json
        - package-lock.json
  - name: builder
    type: registry-image
    source:
      repository: jbhannah/jbhannah.net
      tag: builder
      username: ((docker.username))
      password: ((docker.password))

jobs:
  - name: base
    plan:
      - get: base-spec
        trigger: true
      - task: build
        privileged: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: jbhannah/buildkit-ubuntu
          inputs:
            - name: git
          caches:
            - path: cache
          outputs:
            - name: image
          run:
            path: buildctl
            args:
              - build
              - --frontend
              - dockerfile.v0
              - --local
              - context=./git
              - --local
              - dockerfile=./git
              - --opt
              - filename=Dockerfile.base
              - --export-cache
              - type=local,dest=./cache
              - --output
              - type=docker,name=jbhannah/jbhannah.net:base,dest=./image/image.tar
      - put: base
        params:
          image: image/image.tar
  - name: build
    plan:
      - get: deps
        trigger: true
      - task: build
        privileged: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: jbhannah/buildkit-ubuntu
          inputs:
            - name: git
          caches:
            - path: cache
          outputs:
            - name: image
          run:
            path: buildctl
            args:
              - build
              - --frontend
              - dockerfile.v0
              - --local
              - context=./git
              - --local
              - dockerfile=./git
              - --opt
              - filename=Dockerfile.builder
              - --export-cache
              - type=local,dest=./cache
              - --output
              - type=docker,name=jbhannah/jbhannah.net:builder,dest=./image/image.tar
      - put: builder
        params:
          image: image/image.tar
  - name: test
    plan:
      - in_parallel:
          - get: git
            trigger: true
          - get: builder
            trigger: true
            passed:
              - build
      - task: test
        image: builder
        config:
          platform: linux
          run:
            dir: /app
            path: npm
            args:
              - test
  - name: lint
    plan:
      - in_parallel:
          - get: git
            trigger: true
          - get: builder
            trigger: true
            passed:
              - build
      - task: test
        image: builder
        config:
          platform: linux
          run:
            dir: /app
            path: npm
            args:
              - run
              - lint
